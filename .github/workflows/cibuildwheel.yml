name: Release (GitHub + PyPI)

on:
  workflow_dispatch: {}

permissions:
  contents: write

env:
  CIBW_BUILD: "cp312-* cp313-* cp314-*"
  CIBW_OUTPUT_DIR: wheelhouse

jobs:
  prepare:
    name: Read version and create GitHub release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: latest

      - name: Install build dependencies
        run: uv sync --dev

      - name: Read version from pyproject.toml
        id: version
        run: |
          uv run python - <<'EOF'
          import tomllib
          from pathlib import Path

          data = tomllib.loads(Path("pyproject.toml").read_text())
          version = data["project"]["version"]

          with open("$GITHUB_OUTPUT", "a") as f:
              f.write(f"version={version}\n")
          EOF

      - name: Create and push git tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git tag -a "v${{ steps.version.outputs.version }}" \
            -m "Release v${{ steps.version.outputs.version }}"

          git push origin "v${{ steps.version.outputs.version }}"

      - name: Create GitHub Release (draft)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          draft: true
          prerelease: false
          body: |
            ## SeeMPS v${{ steps.version.outputs.version }}

            ### Summary
            <!-- Brief, high-level description of this release -->

            ### Highlights
            <!-- Bullet points with the most important changes -->
            - 
            - 
            -

            ## Installation

            ```bash
            pip install seemps==${{ inputs.version }}
            ```

            ## What's Changed
            * See commit history for detailed changes

            ---
            _Edit these release notes before publishing._
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  sdist:
    name: Build sdist
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: latest

      - name: Install build dependencies
        run: uv sync --dev

      - name: Build sdist
        run: |
          uv pip install build
          uv run python -m build --sdist

      - uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz

  wheels-linux:
    name: Build wheels (Linux)
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: latest

      - name: Install build dependencies
        run: uv sync --dev

      - name: Install cibuildwheel
        run: uv pip install cibuildwheel

      - name: Build wheels
        run: uv run python -m cibuildwheel --output-dir "$CIBW_OUTPUT_DIR"

      - uses: actions/upload-artifact@v4
        with:
          name: wheels-linux
          path: wheelhouse/*.whl

  wheels-macos:
    if: false
    name: Build wheels (macOS)
    runs-on: macos-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: latest

      - name: Install build dependencies
        run: uv sync --dev

      - name: Install cibuildwheel
        run: uv pip install cibuildwheel

      - name: Build wheels
        run: uv run python -m cibuildwheel --output-dir "$CIBW_OUTPUT_DIR"

      - uses: actions/upload-artifact@v4
        with:
          name: wheels-macos
          path: wheelhouse/*.whl

  wheels-windows:
    if: false
    name: Build wheels (Windows)
    runs-on: windows-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: latest

      - name: Install build dependencies
        run: uv sync --dev
  
      - name: Install cibuildwheel
        run: uv pip install cibuildwheel

      - name: Build wheels
        run: uv run python -m cibuildwheel --output-dir "%CIBW_OUTPUT_DIR%"

      - uses: actions/upload-artifact@v4
        with:
          name: wheels-windows
          path: wheelhouse/*.whl

  publish:
    name: Upload to GitHub Release and PyPI
    runs-on: ubuntu-latest
    needs: [prepare, sdist, wheels-linux]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: latest

      - name: Install build dependencies
        run: uv sync --dev

      - name: Upload to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          uv pip install twine
          uv run python -m twine upload \
            sdist/*.tar.gz \
            wheels-linux/*.whl
#            wheels-macos/*.whl \
#            wheels-windows/*.whl

      - name: Attach artifacts to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare.outputs.version }}
          files: |
            sdist/*.tar.gz
            wheels-linux/*.whl
#            wheels-macos/*.whl
#            wheels-windows/*.whl
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


